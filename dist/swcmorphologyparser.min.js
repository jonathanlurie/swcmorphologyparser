!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.swcmorphologyparser={})}(this,function(t){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function n(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),t}function a(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var h=1,l=function(){function a(t,e,n,o,r,i){s(this,a),this._id=t,this._type=e,this._position=[n,o,r],this._radius=i,this._parent=null,this._children=[],this._hasSomaChildren=!1}return n(a,[{key:"getId",value:function(){return this._id}},{key:"getType",value:function(){return this._type}},{key:"isSoma",value:function(){return this._type===h}},{key:"getRadius",value:function(){return this._radius}},{key:"getPosition",value:function(){return this._position}},{key:"setParent",value:function(t){(this._parent=t)._addChild(this)}},{key:"getParent",value:function(){return this._parent}},{key:"_addChild",value:function(t){this.doesAlreadyHaveChild(t)||(this._children.push(t),this._hasSomaChildren=t.isSoma()||this._hasSomaChildren)}},{key:"getChildren",value:function(){return this._children}},{key:"getNonSomaChildren",value:function(){if(!this._hasSomaChildren)return this._children;for(var t=[],e=0;e<this._children.length;e++)this._children[e].isSoma()||t.push(this._children[e]);return t}},{key:"doesAlreadyHaveChild",value:function(t){for(var e=0;e<this._children.length;e++)if(this._children[e].getId()===t.getId())return!0;return!1}},{key:"dive",value:function(t){t.push(this);var e=this.getNonSomaChildren();return 1!==e.length?e:e[0].getType()===this._type?e[0].dive(t):void console.warn("Non-soma node (id:".concat(this._id," type:").concat(this._type,") has a single child of different type (id:").concat(e[0].getId()," type:").concat(this.getType(),")"))}}]),a}(),r=function(){function e(t){s(this,e),this._nodes={},this._rawSoma=null,this._rawSections=null,this._rawMorphology=null,this._morphology=null,this._initCollection(t),this._buildSections(),this._buildRawMorphology()}return n(e,[{key:"getRawMorphology",value:function(){return this._rawMorphology}},{key:"getMorphology",value:function(){return this._morphology}},{key:"_initCollection",value:function(t){for(var e=[],n=0;n<t.length;n++){var o=new l(t[n][0],t[n][1],t[n][2],t[n][3],t[n][4],t[n][5]);this._nodes[t[n][0]]=o,t[n][1]===h&&e.push(o);var r=t[n][6];if(-1!==r){var i=this._nodes[r];o.setParent(i)}}e.length&&(this._rawSoma={id:0,type:"soma",radius:Math.max.apply(Math,a(e.map(function(t){return t.getRadius()}))),points:e.map(function(t){return{position:t.getPosition()}})})}},{key:"_buildSections",value:function(){var s=0,h=[],t=null,e=[];for(var n in this._nodes){var o=this._nodes[n].getNonSomaChildren();if(0<o.length){t=this._nodes[n],e=o;break}}if(t){for(var l=[],r=0;r<e.length;r++)l.push({node:e[r],parentSectionId:null});for(;l.length;){var i=l.pop(),a=u(i.node,i.parentSectionId);h.push(a),h[a.id]=a}h.length&&(this._rawSections=h)}else console.warn("No valid section here");function u(t,e){var n=[];t.getParent()&&n.push(t.getParent());var o=t.dive(n),r=n.map(function(t){return{position:t.getPosition(),radius:t.getRadius()}});null===e&&r.length&&(r[0].radius=0);var i={typevalue:t.getType(),typename:null,points:r,id:s,children:[],parent:e};e&&h[e].children.push(s);for(var a=0;a<o.length;a++)l.push({node:o[a],parentSectionId:s});return s++,i}}},{key:"_buildRawMorphology",value:function(){this._rawSections||console.warn("This morphology has no section to export"),this._rawSoma||console.warn("This morphology has no soma to show"),this._rawSections||this._rawSoma?this._rawMorphology={soma:this._rawSoma,sections:this._rawSections}:console.warn("No valid morphology data.")}}]),e}(),e=function(){function t(){s(this,t),this._morphology=null,this._rawMorphology=null}return n(t,[{key:"parse",value:function(t){this._morphology=null,this._rawMorphology=null;var e=this._extractPoints(t),n=new r(e);this._morphology=n.getMorphology(),this._rawMorphology=n.getRawMorphology()}},{key:"getRawMorphology",value:function(){return this._rawMorphology}},{key:"getMorphology",value:function(){return this._morphology}},{key:"_extractPoints",value:function(t){for(var e=t.replace(/\s*#.*?$/gm,""),n=(e=e.trim().replace(/^\s*$/gm,"")).split("\n"),o=[],r=0;r<n.length;r++){var i=n[r].replace(/^\s+/m,"").replace(/\s+$/m,"").split(/[\s,]+/);7<=i.length&&(o[r]=[Math.round(parseFloat(i[0])),Math.round(parseFloat(i[1])),parseFloat(i[2]),parseFloat(i[3]),parseFloat(i[4]),parseFloat(i[5]),Math.round(parseFloat(i[6]))])}return o}}]),t}();t.SwcParser=e,Object.defineProperty(t,"__esModule",{value:!0})});
